# LiveLearn RAG - Architecture Diagram

## System Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           LiveLearn RAG System                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐             │
│  │   Frontend      │    │   API Gateway   │    │   Monitoring    │             │
│  │   (HTML/JS)     │◄──►│   (FastAPI)     │◄──►│   (Logs/Metrics)│             │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘             │
│           │                       │                       │                    │
│           │                       │                       │                    │
│           ▼                       ▼                       ▼                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Core Services Layer                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │   │
│  │  │    RAG      │  │  Feedback   │  │  Learning   │  │   Trust     │    │   │
│  │  │  Pipeline   │  │  Handler    │  │   Engine    │  │   Scorer    │    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │   │
│  │         │               │               │               │                │   │
│  │         ▼               ▼               ▼               ▼                │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│  │  │              Hybrid Retrieval System                           │    │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │    │   │
│  │  │  │    Dense    │  │     BM25    │  │  Content    │            │    │   │
│  │  │  │  Retrieval  │  │   Search    │  │  Filter     │            │    │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘            │    │   │
│  │  └─────────────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│           │                       │                       │                    │
│           ▼                       ▼                       ▼                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Data Layer                                       │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │   │
│  │  │  SQLite     │  │  Vector     │  │  Feedback   │  │  Metadata   │    │   │
│  │  │  Database   │  │  Store      │  │   Events    │  │   Store     │    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│           │                       │                       │                    │
│           ▼                       ▼                       ▼                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        External Services                                │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                    │   │
│  │  │   Ollama    │  │  Embedding  │  │   File      │                    │   │
│  │  │   (LLM)     │  │   Models    │  │  Storage    │                    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Data Flow Diagram

```
User Question
     │
     ▼
┌─────────────┐
│   Frontend  │
└─────────────┘
     │
     ▼
┌─────────────┐
│  FastAPI    │
│  Gateway    │
└─────────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────┐
│                RAG Pipeline                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │   Query     │  │  Hybrid     │  │   Answer    │    │
│  │ Processing  │  │ Retrieval   │  │ Generation  │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────┐
│            Hybrid Retrieval System                      │
│  ┌─────────────┐              ┌─────────────┐          │
│  │    Dense    │              │     BM25    │          │
│  │  Retrieval  │◄────────────►│   Search    │          │
│  │ (Embeddings)│              │ (Keywords)  │          │
│  └─────────────┘              └─────────────┘          │
│         │                              │                │
│         ▼                              ▼                │
│  ┌─────────────────────────────────────────────────┐    │
│  │         Score Normalization &                   │    │
│  │         Hybrid Combination                      │    │
│  │    score = α·dense + (1-α)·bm25                 │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────┐
│  Database   │
│  (SQLite)   │
└─────────────┘
     │
     ▼
┌─────────────┐
│   Ollama    │
│   (LLM)     │
└─────────────┘
     │
     ▼
┌─────────────┐
│   Answer    │
└─────────────┘
```

## Component Interaction Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Component Interactions                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Frontend ──────────────┐                                                      │
│                         │                                                      │
│  API Gateway ───────────┼─── RAG Pipeline ──── Hybrid Retrieval ──── Database  │
│                         │         │                    │              │        │
│  Monitoring ────────────┘         │                    │              │        │
│                                   │                    │              │        │
│  Feedback Handler ────────────────┼─── Learning Engine ──── Trust Scorer       │
│                                   │                                              │
│  Content Filter ──────────────────┘                                              │
│                                                                                 │
│  External Services:                                                             │
│  • Ollama (LLM)                                                                 │
│  • Embedding Models                                                             │
│  • File Storage                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Database Schema Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Database Schema                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                        │
│  │  Documents  │    │   Chunks    │    │ ChunkWeights│                        │
│  │             │    │             │    │             │                        │
│  │ id (PK)     │◄──►│ id (PK)     │    │ id (PK)     │                        │
│  │ uri         │    │ document_id │    │ chunk_id    │                        │
│  │ metadata    │    │ content     │    │ penalty_wt  │                        │
│  │ created_at  │    │ embedding   │    │ boost_wt    │                        │
│  └─────────────┘    │ source      │    │ is_deprecated│                       │
│                     │ version     │    └─────────────┘                        │
│                     └─────────────┘                                           │
│                                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                        │
│  │MessageSessions│  │FeedbackEvents│   │IndexMutations│                        │
│  │             │    │             │    │             │                        │
│  │ id (PK)     │◄──►│ id (PK)     │◄──►│ id (PK)     │                        │
│  │ session_id  │    │ message_id  │    │ feedback_id │                        │
│  │ question    │    │ label       │    │ operation   │                        │
│  │ answer      │    │ rating      │    │ status      │                        │
│  │ contexts    │    │ correction  │    │ target_doc  │                        │
│  └─────────────┘    │ is_spam     │    │ target_chunk│                        │
│                     │ confidence  │    └─────────────┘                        │
│                     └─────────────┘                                           │
│                                                                                 │
│  ┌─────────────┐    ┌─────────────┐                                           │
│  │UserSpamMetrics│  │ContentQuality│                                          │
│  │             │    │   Metrics   │                                           │
│  │ id (PK)     │    │ id (PK)     │                                           │
│  │ user_id     │    │ chunk_id    │                                           │
│  │ spam_count  │    │ pos_feedback│                                           │
│  │ reputation  │    │ neg_feedback│                                           │
│  │ is_trusted  │    │ avg_rating  │                                           │
│  └─────────────┘    │ confidence  │                                           │
│                     └─────────────┘                                           │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Technology Stack Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Technology Stack                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Frontend Layer:                                                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                            │
│  │    HTML5    │  │ JavaScript  │  │     CSS3    │                            │
│  └─────────────┘  └─────────────┘  └─────────────┘                            │
│                                                                                 │
│  API Layer:                                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                            │
│  │   FastAPI   │  │   Uvicorn   │  │   Pydantic  │                            │
│  └─────────────┘  └─────────────┘  └─────────────┘                            │
│                                                                                 │
│  Business Logic:                                                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                            │
│  │   RAG       │  │  Feedback   │  │  Learning   │                            │
│  │  Pipeline   │  │  Handler    │  │   Engine    │                            │
│  └─────────────┘  └─────────────┘  └─────────────┘                            │
│                                                                                 │
│  AI/ML Layer:                                                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   Ollama    │  │   Llama     │  │  Embeddings │  │   BM25      │          │
│  │   (LLM)     │  │   3.2       │  │   (Nomic)   │  │  (Scikit)   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                                                 │
│  Data Layer:                                                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                            │
│  │   SQLite    │  │ SQLAlchemy  │  │   Alembic   │                            │
│  └─────────────┘  └─────────────┘  └─────────────┘                            │
│                                                                                 │
│  Utilities:                                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   Loguru    │  │   NumPy     │  │   SciPy     │  │  Tiktoken   │          │
│  │ (Logging)   │  │ (Math)      │  │ (Science)   │  │(Tokenization)│          │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Request Flow Sequence

```
1. User Input
   │
   ▼
2. Frontend Validation
   │
   ▼
3. API Gateway (FastAPI)
   │
   ▼
4. RAG Pipeline
   │
   ▼
5. Query Processing
   │
   ▼
6. Hybrid Retrieval
   ├── Dense Search (Embeddings)
   └── BM25 Search (Keywords)
   │
   ▼
7. Score Normalization & Combination
   │
   ▼
8. Database Query (SQLite)
   │
   ▼
9. Context Retrieval
   │
   ▼
10. LLM Generation (Ollama)
    │
    ▼
11. Answer Post-processing
    │
    ▼
12. Response to User
```

## Security & Monitoring Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Security & Monitoring                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Input Validation ────┐                                                        │
│                       │                                                        │
│  Rate Limiting ───────┼─── Anti-Spam System ──── Trust Scoring ──── User Rep   │
│                       │                                                        │
│  Content Filter ──────┘                                                        │
│                                                                                 │
│  Logging System ────┐                                                          │
│                     │                                                          │
│  Metrics Collection ─┼─── Health Monitoring ──── Performance Tracking          │
│                     │                                                          │
│  Error Handling ────┘                                                          │
└─────────────────────────────────────────────────────────────────────────────────┘
```

Эта архитектурная диаграмма показывает полную структуру системы LiveLearn RAG, включая все компоненты, их взаимодействие и потоки данных.
