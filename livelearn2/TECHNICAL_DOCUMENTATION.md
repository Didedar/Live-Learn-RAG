# LiveLearn RAG - Техническая документация

## Обзор системы

**LiveLearn RAG** - это система Retrieval-Augmented Generation (RAG) с возможностью обучения на основе пользовательской обратной связи. Система использует локальные модели через Ollama и реализует гибридный поиск (Dense + BM25) для точного извлечения информации из векторного хранилища.

### Ключевые особенности

- **Локальная обработка**: Использует Ollama для работы с моделями Llama локально
- **Гибридный поиск**: Комбинация плотного поиска (Dense) и BM25 для точного извлечения
- **Система обратной связи**: Обучение на основе пользовательских исправлений и оценок
- **Разделение контента**: Четкое разделение оригинального контента и пользовательских фидбеков
- **Антиспам защита**: Система фильтрации спама и оценки качества контента
- **Мониторинг производительности**: Отслеживание метрик и KPI системы

## Архитектура системы

```
livelearn2/
├── app/                          # Основное приложение
│   ├── main.py                   # Точка входа FastAPI
│   ├── config.py                 # Конфигурация приложения
│   ├── database.py               # Управление базой данных
│   ├── api/                      # API эндпоинты
│   │   └── v1/                   # Версия 1 API
│   │       ├── rag.py            # Базовый RAG API
│   │       ├── feedback.py       # Система обратной связи
│   │       ├── hybrid_rag.py     # Гибридный RAG
│   │       ├── enhanced_rag.py   # Улучшенный RAG
│   │       ├── strict_rag.py     # Строгий RAG с разделением
│   │       └── ...               # Другие варианты RAG
│   ├── models/                   # Модели базы данных
│   │   ├── documents.py          # Документы и чанки
│   │   └── feedback.py           # Модели обратной связи
│   ├── schemas/                  # Pydantic схемы
│   │   ├── rag.py               # Схемы RAG API
│   │   └── feedback.py          # Схемы обратной связи
│   ├── services/                 # Бизнес-логика
│   │   ├── rag_pipeline.py      # Основной RAG пайплайн
│   │   ├── hybrid_rag_pipeline.py # Гибридный пайплайн
│   │   ├── strict_rag_pipeline.py # Строгий пайплайн
│   │   ├── feedback_handler.py   # Обработка фидбеков
│   │   ├── learning_engine.py    # Движок обучения
│   │   ├── trust_scorer.py       # Оценка доверия
│   │   ├── embeddings.py         # Эмбеддинги
│   │   ├── ollama_llm.py         # LLM через Ollama
│   │   └── ...                   # Другие сервисы
│   ├── core/                     # Основные компоненты
│   │   ├── exceptions.py         # Исключения
│   │   ├── logging.py            # Логирование
│   │   └── security.py           # Безопасность
│   └── utils/                    # Утилиты
│       ├── text_processing.py    # Обработка текста
│       ├── vectors.py            # Работа с векторами
│       └── excel_utils.py        # Работа с Excel
├── tests/                        # Тесты
├── migrations/                   # Миграции БД
├── logs/                         # Логи
├── requirements.txt              # Зависимости
└── README.md                     # Документация
```

## Основные компоненты

### 1. FastAPI приложение (`main.py`)

**Назначение**: Главный файл приложения с настройкой FastAPI, middleware и роутеров.

**Ключевые особенности**:
- Поддержка CORS и GZIP сжатия
- Rate limiting для защиты от спама
- Мониторинг производительности запросов
- Обработка исключений с детальным логированием
- Health check эндпоинты
- Ленивая загрузка настроек

**Основные эндпоинты**:
- `GET /` - Информация о системе
- `GET /healthz` - Базовая проверка здоровья
- `GET /healthz/detailed` - Детальная проверка с зависимостями
- `GET /metrics` - Метрики системы

### 2. Конфигурация (`config.py`)

**Назначение**: Управление настройками приложения через Pydantic Settings.

**Основные настройки**:
```python
# Приложение
app_name: str = "Live-Learn RAG with Ollama"
app_env: str = "dev"
debug: bool = False

# База данных
db_path: str = "./rag.db"

# RAG настройки
chunk_size: int = 400
chunk_overlap: int = 40
default_top_k: int = 6

# Ollama (локальные модели)
ollama_url: str = "http://localhost:11434"
ollama_model: str = "llama3.2:latest"
ollama_embedding_model: str = "nomic-embed-text:latest"

# Гибридный поиск
use_hybrid_search: bool = True
hybrid_alpha: float = 0.6  # Вес для dense vs keyword
retrieval_threshold: float = 0.4

# Обратная связь
feedback_penalty_weight: float = -0.3
feedback_boost_weight: float = 0.5
spam_detection_threshold: float = 0.3
```

### 3. База данных (`database.py`)

**Назначение**: Управление подключением к SQLite базе данных и миграциями.

**Основные функции**:
- Создание и управление сессиями БД
- Автоматические миграции
- Проверка здоровья БД
- Оптимизация производительности
- Резервное копирование
- Очистка старых данных

**Модели данных**:
- `Document` - Метаданные документов
- `Chunk` - Текстовые фрагменты с эмбеддингами
- `MessageSession` - Сессии вопрос-ответ
- `FeedbackEvent` - События обратной связи
- `ChunkWeight` - Веса чанков на основе фидбека
- `UserSpamMetrics` - Метрики спама пользователей
- `ContentQualityMetrics` - Метрики качества контента

### 4. Модели данных

#### Документы (`models/documents.py`)

```python
class Document(Base):
    id: int
    uri: str
    doc_metadata: dict
    created_at: datetime
    chunks: List[Chunk]

class Chunk(Base):
    id: int
    document_id: int
    ordinal: int
    content: str
    embedding: List[float]
    source: str  # "original" или "user_feedback"
    version: int
    created_at: datetime
```

#### Обратная связь (`models/feedback.py`)

```python
class MessageSession(Base):
    id: str
    session_id: str
    question: str
    answer: str
    contexts_used: List[dict]
    created_at: datetime

class FeedbackEvent(Base):
    id: str
    message_id: str
    label: FeedbackLabel  # like, dislike, correct, incorrect, etc.
    rating: Optional[int]  # 1-5 звезд
    correction_text: Optional[str]
    scope: FeedbackScope  # chunk, document, global, answer
    target_doc_id: Optional[int]
    target_chunk_id: Optional[int]
    is_spam: bool
    is_filtered: bool
    confidence_score: float
    status: UpdateStatus
```

### 5. API эндпоинты

#### Базовый RAG (`api/v1/rag.py`)

**Основные эндпоинты**:
- `POST /ingest` - Загрузка документов
- `POST /query` - Поиск по базе знаний
- `GET /documents` - Список документов
- `DELETE /documents/{doc_id}` - Удаление документа
- `GET /stats` - Статистика системы

#### Система обратной связи (`api/v1/feedback.py`)

**Основные эндпоинты**:
- `POST /ask` - Задать вопрос с получением ответа
- `POST /feedback` - Предоставить обратную связь
- `GET /feedback/history` - История фидбеков
- `GET /feedback/stats` - Статистика фидбеков
- `POST /feedback/revert` - Откат изменений

#### Гибридный RAG (`api/v1/hybrid_rag.py`)

**Особенности**:
- Комбинация плотного поиска и BM25
- Настраиваемые веса для разных типов поиска
- Улучшенная точность извлечения

#### Строгий RAG (`api/v1/strict_rag.py`)

**Особенности**:
- Строгое разделение оригинального контента и фидбеков
- Метод `ask_with_feedback_separation` для явного разделения
- Защита от загрязнения базы знаний пользовательскими данными

### 6. Сервисы

#### RAG Pipeline (`services/rag_pipeline.py`)

**Основные методы**:
- `ingest_document()` - Загрузка и обработка документов
- `ask()` - Генерация ответов на вопросы
- `retrieve_with_feedback()` - Поиск с учетом фидбеков
- `get_rag_stats()` - Получение статистики

#### Гибридный поиск (`services/hybrid_rag_pipeline.py`)

**Особенности**:
- Комбинация dense и BM25 поиска
- Нормализация и взвешивание результатов
- Настраиваемые параметры поиска

#### Обработка фидбеков (`services/feedback_handler.py`)

**Основные функции**:
- Валидация пользовательского ввода
- Антиспам фильтрация
- Оценка качества контента
- Применение изменений к базе знаний

#### Движок обучения (`services/learning_engine.py`)

**Функции**:
- Обработка валидированных фидбеков
- Обновление весов чанков
- Создание новых чанков на основе исправлений
- Управление версиями контента

#### Оценка доверия (`services/trust_scorer.py`)

**Алгоритм оценки**:
- История пользователя
- Качество контента
- Консистентность фидбеков
- Надежность источника
- Временные факторы

### 7. Система безопасности

#### Антиспам защита

**Метрики**:
- Частота отправки фидбеков
- Качество контента
- Поведенческие паттерны
- IP и User-Agent анализ

**Фильтры**:
- Rate limiting
- Контент-фильтры
- Анализ репутации пользователя

#### Валидация данных

**Pydantic схемы**:
- Валидация входных данных
- Санитизация контента
- Проверка размеров файлов
- Валидация метаданных

## Технические особенности

### 1. Гибридный поиск

**Компоненты**:
- **Dense поиск**: Векторный поиск по эмбеддингам
- **BM25 поиск**: Статистический поиск по ключевым словам
- **Нормализация**: Приведение оценок к единой шкале
- **Взвешивание**: Настраиваемые веса для разных методов

**Преимущества**:
- Высокая точность для семантических запросов
- Эффективность для фактологических запросов
- Устойчивость к опечаткам и синонимам

### 2. Система обратной связи

**Типы фидбека**:
- `LIKE/DISLIKE` - Общая оценка
- `CORRECT/INCORRECT` - Оценка правильности
- `HELPFUL/NOT_HELPFUL` - Оценка полезности

**Области применения**:
- `CHUNK` - Конкретный фрагмент
- `DOCUMENT` - Весь документ
- `GLOBAL` - Глобальные настройки
- `ANSWER` - Сгенерированный ответ

### 3. Разделение контента

**Источники**:
- `original` - Оригинальный контент из документов
- `user_feedback` - Контент, созданный пользователями

**Защита**:
- Строгое разделение при поиске
- Отдельные метрики для каждого типа
- Возможность отключения пользовательского контента

### 4. Мониторинг и метрики

**KPI метрики**:
- Общее количество фидбеков
- Процент применения фидбеков
- Средняя оценка качества
- Показатель доверия
- Репутация пользователей
- Качество контента
- Здоровье системы
- Эффективность обучения

## Развертывание

### Требования

**Системные требования**:
- Python 3.8+
- SQLite 3
- Ollama (для локальных моделей)
- 4GB+ RAM (рекомендуется 8GB+)

**Зависимости**:
```
fastapi==0.104.1
uvicorn[standard]==0.24.0
sqlalchemy==2.0.23
pydantic==2.5.2
loguru==0.7.2
scikit-learn==1.3.2
numpy==1.24.4
```

### Установка

1. **Клонирование репозитория**:
```bash
git clone <repository-url>
cd livelearn2
```

2. **Установка зависимостей**:
```bash
pip install -r requirements.txt
```

3. **Настройка Ollama**:
```bash
# Установка Ollama
curl -fsSL https://ollama.ai/install.sh | sh

# Загрузка моделей
ollama pull llama3.2:latest
ollama pull nomic-embed-text:latest
```

4. **Запуск приложения**:
```bash
python -m app.main
# или
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### Конфигурация

**Переменные окружения**:
```bash
# Основные настройки
APP_ENV=dev
DEBUG=false
DB_PATH=./rag.db

# Ollama настройки
OLLAMA_URL=http://localhost:11434
OLLAMA_MODEL=llama3.2:latest
OLLAMA_EMBEDDING_MODEL=nomic-embed-text:latest

# RAG настройки
CHUNK_SIZE=400
CHUNK_OVERLAP=40
DEFAULT_TOP_K=6

# Гибридный поиск
USE_HYBRID_SEARCH=true
HYBRID_ALPHA=0.6
RETRIEVAL_THRESHOLD=0.4

# Обратная связь
FEEDBACK_PENALTY_WEIGHT=-0.3
FEEDBACK_BOOST_WEIGHT=0.5
SPAM_DETECTION_THRESHOLD=0.3
```

## API Документация

### Базовые эндпоинты

#### Загрузка документа
```http
POST /api/v1/ingest
Content-Type: application/json

{
  "text": "Содержимое документа",
  "metadata": {"title": "Название", "author": "Автор"},
  "sync": true
}
```

#### Поиск по базе знаний
```http
POST /api/v1/query
Content-Type: application/json

{
  "query": "Ваш вопрос",
  "top_k": 6
}
```

#### Задать вопрос с фидбеком
```http
POST /api/v1/feedback/ask
Content-Type: application/json

{
  "question": "Ваш вопрос",
  "session_id": "optional-session-id",
  "top_k": 6
}
```

#### Предоставить обратную связь
```http
POST /api/v1/feedback/feedback
Content-Type: application/json

{
  "message_id": "id-from-ask-response",
  "user_feedback": {
    "label": "incorrect",
    "correction_text": "Правильный ответ",
    "scope": "chunk",
    "target": {
      "doc_id": 1,
      "chunk_id": 5
    }
  }
}
```

### Гибридный поиск

#### Строгий RAG с разделением
```http
POST /api/v1/strict/ask-with-feedback-separation
Content-Type: application/json

{
  "question": "Ваш вопрос",
  "include_feedback": false,
  "top_k": 4
}
```

## Мониторинг и отладка

### Логирование

**Уровни логов**:
- `INFO` - Общая информация о работе
- `WARNING` - Предупреждения о проблемах
- `ERROR` - Ошибки, требующие внимания
- `DEBUG` - Детальная отладочная информация

**Файлы логов**:
- `logs/app.log` - Основные логи приложения
- `logs/errors.log` - Логи ошибок

### Health Check

**Базовый health check**:
```http
GET /healthz
```

**Детальный health check**:
```http
GET /healthz/detailed
```

**Метрики системы**:
```http
GET /metrics
```

### Отладка

**Включение debug режима**:
```bash
export DEBUG=true
export APP_ENV=dev
```

**Проверка базы данных**:
```python
from app.database import check_db_health
print(check_db_health())
```

## Производительность

### Оптимизация

**База данных**:
- Индексы на часто используемые поля
- WAL режим для SQLite
- Регулярная оптимизация (VACUUM, ANALYZE)

**Поиск**:
- Кэширование эмбеддингов
- Параллельная обработка запросов
- Оптимизация размеров чанков

**Память**:
- Ленивая загрузка больших объектов
- Очистка неиспользуемых данных
- Мониторинг использования памяти

### Масштабирование

**Горизонтальное масштабирование**:
- Разделение базы данных по документам
- Распределение нагрузки между инстансами
- Использование внешних векторных БД

**Вертикальное масштабирование**:
- Увеличение RAM для больших моделей
- Использование GPU для ускорения
- Оптимизация алгоритмов поиска

## Безопасность

### Защита от атак

**Rate Limiting**:
- Ограничение количества запросов в минуту
- Блокировка подозрительных IP
- Анализ паттернов поведения

**Валидация входных данных**:
- Проверка размеров файлов
- Санитизация текста
- Валидация метаданных

**Антиспам система**:
- Анализ репутации пользователей
- Фильтрация низкокачественного контента
- Обнаружение ботов и автоматических запросов

### Конфиденциальность

**Обработка данных**:
- Локальная обработка (без отправки в облако)
- Шифрование чувствительных данных
- Логирование доступа к данным

**Управление сессиями**:
- Анонимные сессии по умолчанию
- Опциональная аутентификация
- Очистка старых данных

## Разработка

### Структура кода

**Принципы**:
- Разделение ответственности
- Dependency Injection
- Асинхронная обработка
- Типизация с Pydantic

**Паттерны**:
- Repository pattern для БД
- Service layer для бизнес-логики
- Factory pattern для создания сервисов
- Observer pattern для событий

### Тестирование

**Типы тестов**:
- Unit тесты для отдельных компонентов
- Integration тесты для API
- E2E тесты для полных сценариев
- Performance тесты для нагрузочного тестирования

**Запуск тестов**:
```bash
# Все тесты
pytest

# Конкретный тест
pytest tests/test_feedback.py

# С покрытием
pytest --cov=app tests/
```

### Расширение функциональности

**Добавление новых типов поиска**:
1. Создать новый сервис в `services/`
2. Реализовать интерфейс поиска
3. Добавить в гибридный пайплайн
4. Создать API эндпоинт

**Добавление новых типов фидбека**:
1. Расширить `FeedbackLabel` enum
2. Обновить схемы валидации
3. Добавить логику обработки
4. Обновить метрики

## Устранение неполадок

### Частые проблемы

**Ollama не запускается**:
```bash
# Проверить статус
ollama list

# Перезапустить сервис
ollama serve

# Проверить модели
ollama pull llama3.2:latest
```

**Проблемы с базой данных**:
```python
# Проверить здоровье БД
from app.database import check_db_health
print(check_db_health())

# Оптимизировать БД
from app.database import optimize_database
optimize_database()
```

**Медленная работа**:
- Проверить размер базы данных
- Оптимизировать индексы
- Увеличить размер чанков
- Настроить кэширование

### Логи и диагностика

**Просмотр логов**:
```bash
# Основные логи
tail -f logs/app.log

# Логи ошибок
tail -f logs/errors.log

# Фильтрация по уровню
grep "ERROR" logs/app.log
```

**Отладка производительности**:
```python
# Включить детальное логирование
import logging
logging.getLogger("app").setLevel(logging.DEBUG)

# Мониторинг запросов
# Включить в config.py: echo=True
```

## Заключение

LiveLearn RAG представляет собой мощную систему для работы с документами и генерации ответов на основе локальных моделей. Система обеспечивает высокую точность поиска благодаря гибридному подходу, безопасность через локальную обработку и возможность непрерывного обучения через систему обратной связи.

Ключевые преимущества:
- **Локальность**: Полный контроль над данными
- **Точность**: Гибридный поиск для лучших результатов
- **Обучение**: Адаптация на основе пользовательской обратной связи
- **Безопасность**: Защита от спама и некачественного контента
- **Масштабируемость**: Возможность расширения и оптимизации

Система готова к использованию в продакшене и может быть адаптирована под конкретные требования проекта.
